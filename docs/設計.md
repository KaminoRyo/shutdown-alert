# アプリケーション設計書 (フェーズ1)

## 1. はじめに

本ドキュメントは、`docs/仕様.md`で定義された要件を満たすためのアプリケーションの内部設計を定めるものである。

## 2. 設計方針

- **軽量・高速**: Go言語の特性を活かし、常駐時のリソース消費を最小限に抑える。
- **Windowsネイティブ**: UIライブラリとしてWindowsネイティブのコンポーネントを利用する`github.com/lxn/walk`を採用し、OSとの親和性を高める。
- **拡張性**: フェーズ2以降の機能追加（設定の外部化など）を考慮し、関心を分離したコンポーネントベースの構造とする。

## 3. ディレクトリ構成

プロジェクトのルートディレクトリは以下のような構成とする。

```
shutdown-alert/
├── go.mod
├── go.sum
├── main.go                    // アプリケーションのエントリーポイント
├── shutdown-alert.manifest    // Windowsアプリケーションマニフェスト
├── rsrc.syso                  // ビルド時に生成されるリソースファイル（.gitignore対象）
└── internal/
    ├── icon/
    │   └── icon.ico           // タスクトレイ用のアイコンファイル
    ├── config/
    │   ├── config.go          // 設定値（URLなど）を管理
    │   └── config_test.go     // configのユニットテスト
    ├── app/
    │   ├── app.go             // アプリケーションのライフサイクル管理
    │   └── wndproc.go         // Win32ウィンドウプロシージャ処理
    ├── ui/
    │   ├── dialog.go          // ダイアログUI構築
    │   └── tray.go            // トレイアイコン構築
    ├── win32/
    │   ├── api.go             // Win32 API呼び出し
    │   └── constants.go       // Win32定数定義
    ├── startup/
    │   └── startup.go         // スタートアップ登録管理
    └── logger/
        └── logger.go          // エラーログ記録
```

- **`main.go`**: 主な責務は、アプリケーションの初期化と実行。
- **`shutdown-alert.manifest`**: Windows共通コントロールv6を有効化するためのマニフェストファイル。
- **`/internal/app`**: アプリケーションのライフサイクル管理とWin32コールバック処理を担う。
- **`/internal/ui`**: ダイアログとトレイアイコンのUI構築ロジックを担う。
- **`/internal/win32`**: Win32 API呼び出しと定数定義を隔離する。
- **`/internal/config`**: リマインド対象のURLなど、設定情報を管理する。
- **`/internal/icon`**: アプリケーションで利用するアイコンを配置する。

## 4. コンポーネント設計

### 4.1. `main.go` (エントリーポイント)

- `internal/app`からアプリケーションのインスタンスを生成する。
- アプリケーションを実行し、メインループを開始する。
- Windowsアプリケーションとして動作させるため、ビルドタグ `//go:build windows` を指定する。

### 4.2. `app`コンポーネント (`internal/app/`)

#### 4.2.1. `app.go` - アプリケーションライフサイクル管理

`walk`ライブラリを利用してアプリケーションの初期化と実行を管理する。

- **App構造体**:
    - `mainWindow *walk.MainWindow`: メインウィンドウへの参照
    - `notifyIcon *walk.NotifyIcon`: トレイアイコンへの参照
    - `urlToOpen string`: 開くべきURL

- **主要メソッド**:
    - `NewApp()`: アプリケーションインスタンスを生成
    - `Run()`: アプリケーションを初期化し、メッセージループを開始
    - `createMainWindow()`: 非表示のメインウィンドウを作成
    - `initNotifyIcon()`: トレイアイコンを初期化（`ui.InitNotifyIcon`を呼び出し）
    - `handleShutdownQuery()`: シャットダウン検知時のダイアログ表示
    - `showConfirmationDialog()`: テスト用のダイアログ表示
    - `openURL()`: URLを開く（`win32.ShellExecute`を呼び出し）

#### 4.2.2. `wndproc.go` - Win32ウィンドウプロシージャ

Win32コールバックの制約により、グローバル変数を使用してウィンドウメッセージを処理する。

- **グローバル変数**（Win32 API制約のため必要）:
    - `appInstance *App`: コールバックからアプリケーションインスタンスにアクセスするため
    - `origWndProc uintptr`: 元のウィンドウプロシージャへの参照

- **主要関数**:
    - `wndProcCallback()`: カスタムウィンドウプロシージャ
        - `WM_QUERYENDSESSION`を捕捉し、シャットダウンブロックを設定
        - `WM_SHOW_DIALOG`でダイアログを表示
    - `installWndProcHook()`: カスタムウィンドウプロシージャをインストール

### 4.3. `ui`コンポーネント (`internal/ui/`)

#### 4.3.1. `dialog.go` - ダイアログUI構築

- **ShowConfirmationDialog()**:
    - 確認ダイアログを表示する関数
    - コールバック関数（`onOpen`, `onExit`）を受け取り、ボタンクリック時に実行
    - ダイアログの重複コードを排除し、一元化
    - **アラートモード対応**: `urlToOpen`が空文字列の場合、「開く」ボタンを非表示にし、「閉じる」ボタンのみ表示
    - ボタンの構成を動的に生成し、URLの有無に応じて適切なUIを提供

#### 4.3.2. `tray.go` - トレイアイコン構築

- **InitNotifyIcon()**:
    - トレイアイコンを作成し、コンテキストメニューを設定
    - コールバック関数（`onTest`, `onExit`）を受け取り、メニュー選択時に実行
    - アイコン、ツールチップ、メニュー項目を設定

### 4.4. `win32`コンポーネント (`internal/win32/`)

#### 4.4.1. `constants.go` - Win32定数定義

- **Win32メッセージ定数**:
    - `WM_QUERYENDSESSION` (0x0011): シャットダウン/ログオフ検知用
    - `WM_ENDSESSION` (0x0016): セッション終了通知
    - `WM_USER` (0x0400): ユーザー定義メッセージの基準値
    - `WM_SHOW_DIALOG`: カスタムメッセージ（ダイアログ表示用）

- **ShellExecute定数**:
    - `SW_SHOWNORMAL` (1): ウィンドウを通常表示

#### 4.4.2. `api.go` - Win32 API呼び出し

Win32 APIへの呼び出しを隔離し、副作用を明示する。

- **ShutdownBlockReasonCreate()**: シャットダウンブロック理由を設定
- **ShutdownBlockReasonDestroy()**: シャットダウンブロック理由をクリア
- **PostMessage()**: ウィンドウメッセージキューにメッセージを投稿
- **SetForegroundWindow()**: ウィンドウを前面に表示
- **ShellExecute()**: デフォルトアプリケーションでファイル/URLを開く

### 4.5. `startup`コンポーネント (`internal/startup/startup.go`)

Windowsスタートアップへの登録・解除を管理する。

- **主要関数**:
    - `IsRegistered()`: スタートアップ登録状態を確認
    - `Register()`: スタートアップに登録（レジストリに実行ファイルパスを書き込み）
    - `Unregister()`: スタートアップから解除（レジストリから削除）
    - `UpdateIfNeeded()`: 実行ファイル移動時の自動パス更新
    - `getExecutablePath()`: 実行ファイルの絶対パスを取得

- **レジストリキー**: `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run`
- **レジストリ値名**: `ShutdownAlert`

### 4.6. `logger`コンポーネント (`internal/logger/logger.go`)

エラーログをJSON形式で記録する。

- **主要関数**:
    - `LogError()`: エラーをログファイルに記録
    - `getLogFilePath()`: ログファイルパスを取得
    - `readExistingLogs()`: 既存のログを読み込み
    - `writeLogsToFile()`: ログをファイルに書き込み

- **ログファイル**: `error_log.json`（実行ファイルと同じディレクトリ）
- **最大エントリ数**: 100（古いものから自動削除）
- **ログ形式**: JSON配列

### 4.7. `config`コンポーネント (`internal/config/config.go`)

アプリケーション全体で使用する定数と、外部設定ファイルの読み込み機能を提供する。

#### 4.7.1. 定数定義

すべての定数は純粋な値であり、副作用を持たない。

**定義される定数**:

- **デフォルト設定値**（設定ファイルで上書き可能）:
    - `TargetURL`: 開く対象のURL（例: `https://www.google.com`）
    - `DialogWidth`: 確認ダイアログの最小幅（640）
    - `DialogHeight`: 確認ダイアログの最小高さ（480）
    - `DialogMessageFormat`: ダイアログメッセージのデフォルト値

- **固定設定値**（設定ファイルで上書き不可）:
    - `DialogTitle`: 確認ダイアログのタイトル（`Shutdown Alert`）
    - `ShutdownBlockMessage`: シャットダウン画面に表示されるメッセージ
    - `OpenButtonLabel`: 「開く」ボタンのラベル（`開く(&O)`）
    - `ExitButtonLabel`: 「閉じる」ボタンのラベル（`閉じる(&E)`）
    - `MessageBoxTitleError`: エラーダイアログのタイトル（`エラー`）
    - `MessageBoxTitleSuccess`: 成功ダイアログのタイトル（`成功`）

- **トレイアイコン設定**:
    - `TrayIconTooltip`: トレイアイコンのツールチップテキスト
    - `TrayMenuTest`: テストダイアログメニュー項目のラベル（`&ダイアログ表示(&T)`）
    - `TrayMenuStartup`: スタートアップ登録メニュー項目のラベル（`スタートアップに登録(&S)`）
    - `TrayMenuExit`: 終了メニュー項目のラベル（`&終了(&E)`）
    - `IconResourceID`: リソースに埋め込まれたアイコンのID（2）

- **スタートアップ設定**:
    - `RegistryValueName`: レジストリ値名（`ShutdownAlert`）
    - `StartupRegisterSuccessMessage`: スタートアップ登録成功メッセージ
    - `StartupRegisterErrorMessageFormat`: スタートアップ登録失敗メッセージフォーマット
    - `StartupUnregisterSuccessMessage`: スタートアップ解除成功メッセージ
    - `StartupUnregisterErrorMessageFormat`: スタートアップ解除失敗メッセージフォーマット

- **ログ設定**:
    - `LogFileName`: ログファイル名（`error_log.json`）
    - `MaxLogEntries`: 最大ログエントリ数（100）

- **リソースパス**:
    - `IconPath`: アプリケーションのアイコンファイルパス（`internal/icon/icon.ico`）

#### 4.7.2. 外部設定ファイル機能

**UserConfig構造体**:
```go
type UserConfig struct {
    TargetURL     string `yaml:"target_url"`
    DialogWidth   int    `yaml:"dialog_width"`
    DialogHeight  int    `yaml:"dialog_height"`
    DialogMessage string `yaml:"dialog_message"`
}
```

**主要関数**:
- `LoadUserConfig(configPath string) (UserConfig, error)`: 設定ファイルを読み込み、デフォルト値とマージ
  - YAMLファイルをパース
  - 省略された項目はデフォルト値を使用
  - バリデーションを実行
  - エラー時はデフォルト値を返す

- `validateURL(targetURL string) error`: URLの安全性を検証（純粋関数）
  - 空文字列は許可（アラートモード）
  - `http://`または`https://`スキームのみ許可
  - ホスト名の存在を確認

- `validateDialogMessage(message string) error`: メッセージの妥当性を検証（純粋関数）
  - 空文字列は拒否

**設定ファイル形式**（`config.yaml`）:
```yaml
target_url: "https://www.google.com"
dialog_width: 640
dialog_height: 480
dialog_message: |
  PCをシャットダウンしようとしています。
  https://www.google.com を開きますか？
```

## 5. 処理フロー

1.  **起動**:
    - `main.go`が実行され、`app.NewApp()`でアプリケーションインスタンスが生成される。
    - `app.Run()`が呼び出され、以下の処理が実行される:
        - グローバル変数`appInstance`にインスタンスを設定
        - `createMainWindow()`で非表示のメインウィンドウを作成
        - `initNotifyIcon()`で`ui.InitNotifyIcon()`を呼び出し、トレイアイコンを表示
        - `installWndProcHook()`でカスタムウィンドウプロシージャをインストール
        - メッセージループを開始

2.  **シャットダウン検知**:
    - OSがシャットダウン/ログオフ処理を開始すると、メインウィンドウが`WM_QUERYENDSESSION`メッセージを受け取る。
    - `wndProcCallback()`がこれを検知し、以下を実行:
        - `win32.ShutdownBlockReasonCreate()`でシャットダウンブロック理由を設定
        - `win32.PostMessage()`で`WM_SHOW_DIALOG`メッセージを投稿
        - `0`を返してシャットダウンを一時的にブロック
    - `WM_SHOW_DIALOG`メッセージを受信すると、`handleShutdownQuery()`を呼び出す

3.  **ユーザー応答**:
    - `ui.ShowConfirmationDialog()`で確認ダイアログを表示
    - ユーザーがボタンをクリックすると、対応するコールバックが実行される:
        - **「開く」ボタン**: `openURL()`でブラウザを起動し、`walk.App().Exit(0)`で終了
        - **「終了」ボタン**: `walk.App().Exit(0)`で終了
    - ダイアログ終了後、`win32.ShutdownBlockReasonDestroy()`でブロック理由をクリア

4.  **終了**:
    - ユーザーがタスクトレイの「Exit」メニューを選択する。
    - `walk.App().Exit(0)`が呼び出され、アプリケーションが終了する。
    - `Run()`メソッド内で`NotifyIcon.Dispose()`が呼び出され、リソースがクリーンアップされる。
    - グローバル変数`appInstance`が`nil`にクリアされる。

## 6. ビルド手順

### 6.1. 必要なツール

- **Go**: 1.20以上
- **rsrc**: マニフェストとアイコンを実行ファイルに埋め込むツール

### 6.2. rsrcのインストール

```cmd
go install github.com/akavel/rsrc@latest
```

### 6.3. ビルドコマンド

```cmd
# リソースファイルの生成
rsrc -manifest shutdown-alert.manifest -ico internal/icon/icon.ico -o rsrc.syso

# GUIモードでビルド（コンソールウィンドウを非表示）
go build -ldflags "-H windowsgui" -o shutdown-alert.exe .
```

### 6.4. デバッグビルド

コンソール出力を確認したい場合は、`-ldflags`を省略する：

```cmd
go build -o shutdown-alert-debug.exe .
```

## 7. 設計原則

### 7.1. 関数型プログラミング原則

本プロジェクトでは、`.clinerules`で定義された関数型プログラミング原則に従う:

- **純粋関数の最大化**: `config`パッケージの関数は全て純粋関数
- **副作用の明示**: 副作用を持つ関数には明示的にコメントを記載
- **状態の最小化**: グローバル変数は`wndproc.go`に隔離し、Win32制約を明示
- **責務の分離**: 各パッケージが単一の責務を持つよう設計

### 7.2. コンポーネント分離の利点

- **可読性**: 各ファイルが100行前後で読みやすい
- **保守性**: 責務が明確で変更の影響範囲が限定的
- **テスタビリティ**: UI構築ロジックが独立し、テスト可能
- **拡張性**: 新機能追加時に既存コードへの影響を最小化

## 8. ライブラリとツール

- **`github.com/lxn/walk`**: UIおよびWindowsイベント処理に使用。
- **`github.com/lxn/win`**: Win32 API（SetWindowLongPtr, ShellExecute等）の呼び出しに使用。
- **`gopkg.in/yaml.v3`**: YAML設定ファイルのパースに使用。
- **`github.com/akavel/rsrc`**: マニフェストファイル(`.manifest`)とアイコンファイル(`.ico`)を実行ファイルに埋め込むために使用するツール。
