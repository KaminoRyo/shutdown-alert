# アプリケーション設計書 (フェーズ1)

## 1. はじめに

本ドキュメントは、`docs/仕様.md`で定義された要件を満たすためのアプリケーションの内部設計を定めるものである。

## 2. 設計方針

- **軽量・高速**: Go言語の特性を活かし、常駐時のリソース消費を最小限に抑える。
- **Windowsネイティブ**: UIライブラリとしてWindowsネイティブのコンポーネントを利用する`github.com/lxn/walk`を採用し、OSとの親和性を高める。
- **拡張性**: フェーズ2以降の機能追加（設定の外部化など）を考慮し、関心を分離したコンポーネントベースの構造とする。

## 3. ディレクトリ構成

プロジェクトのルートディレクトリは以下のような構成とする。

```
shutdown-alert/
├── go.mod
├── go.sum
├── main.go                    // アプリケーションのエントリーポイント
├── shutdown-alert.manifest    // Windowsアプリケーションマニフェスト
├── rsrc.syso                  // ビルド時に生成されるリソースファイル（.gitignore対象）
└── internal/
    ├── icon/
    │   └── icon.ico           // タスクトレイ用のアイコンファイル
    ├── config/
    │   ├── config.go          // 設定値（URLなど）を管理
    │   └── config_test.go     // configのユニットテスト
    └── app/
        └── app.go             // アプリケーション本体のロジック
```

- **`main.go`**: 主な責務は、アプリケーションの初期化と実行。
- **`shutdown-alert.manifest`**: Windows共通コントロールv6を有効化するためのマニフェストファイル。
- **`/internal/app`**: ウィンドウの生成、イベント処理、タスクトレイ管理など、アプリケーションの中核ロジックを担う。
- **`/internal/config`**: リマインド対象のURLなど、設定情報を管理する。
- **`/internal/icon`**: アプリケーションで利用するアイコンを配置する。

## 4. コンポーネント設計

### 4.1. `main.go` (エントリーポイント)

- `internal/app`からアプリケーションのインスタンスを生成する。
- アプリケーションを実行し、メインループを開始する。
- Windowsアプリケーションとして動作させるため、ビルドタグ `//go:build windows` を指定する。

### 4.2. `app`コンポーネント (`internal/app/app.go`)

`walk`ライブラリを利用してUIとイベント処理を実装する。

- **Win32定数**:
    - `WM_QUERYENDSESSION` (0x0011): シャットダウン/ログオフ検知用メッセージ
    - `SW_SHOWNORMAL` (1): ShellExecute用の表示フラグ

- **メインウィンドウ (`MainWindow`)**:
    - `declarative.MainWindow`を使用して非表示（`Visible: false`）のメインウィンドウを生成する。
    - `win.SetWindowLongPtr`を使用してカスタムウィンドウプロシージャ（`WndProc`）をフックし、`WM_QUERYENDSESSION`を捕捉する。

- **タスクトレイ (`NotifyIcon`)**:
    - アプリケーション起動時にタスクトレイにアイコンを表示する。
    - `ni.ContextMenu().Actions().Add()`でコンテキストメニューを定義する。
        - **`Exit`**: `walk.App().Exit(0)`を呼び出してアプリケーションを安全に終了させる。

- **確認ダイアログ**:
    - シャットダウンイベント検知時に、`walk.MsgBox`を使用してYes/No形式のメッセージボックスを表示する。
    - **`はい`ボタンの動作**:
        1. `internal/config`からURLを取得する。
        2. `win.ShellExecute`を使用して、指定されたURLをデフォルトのブラウザで開く。
    - **`いいえ`ボタンの動作**:
        1. 何もせずダイアログを閉じる。

### 4.3. `config`コンポーネント (`internal/config/config.go`)

- フェーズ1では、ハードコードされた固定のURLを返す純粋関数を定義する。

```go
// internal/config/config.go
package config

const TargetURL = "https://www.google.com" // 仕様書記載の仮URL

func GetTargetURL() string {
    return TargetURL
}
```

## 5. 処理フロー

1.  **起動**:
    - `main.go`が実行され、`app.NewApp()`でアプリケーションインスタンスが生成される。
    - `app.Run()`が呼び出され、非表示のメインウィンドウが作成される。
    - タスクトレイにアイコンが表示される。
    - `win.SetWindowLongPtr`でWndProcがフックされ、メッセージループが開始される。

2.  **シャットダウン検知**:
    - OSがシャットダウン/ログオフ処理を開始すると、メインウィンドウが`WM_QUERYENDSESSION`メッセージを受け取る。
    - カスタム`wndProcCallback`がこれを検知し、`showConfirmationDialog()`を呼び出す。

3.  **ユーザー応答**:
    - `walk.MsgBox`で表示されたダイアログでユーザーがボタンをクリックする。
    - `はい`の場合は`win.ShellExecute`でブラウザを起動、`いいえ`の場合は何もしない。

4.  **終了**:
    - ユーザーがタスクトレイの「Exit」メニューを選択する。
    - `walk.App().Exit(0)`が呼び出され、アプリケーションが終了する。
    - `NotifyIcon.Dispose()`でリソースがクリーンアップされる。

## 6. ビルド手順

### 6.1. 必要なツール

- **Go**: 1.20以上
- **rsrc**: マニフェストとアイコンを実行ファイルに埋め込むツール

### 6.2. rsrcのインストール

```cmd
go install github.com/akavel/rsrc@latest
```

### 6.3. ビルドコマンド

```cmd
# リソースファイルの生成
rsrc -manifest shutdown-alert.manifest -ico internal/icon/icon.ico -o rsrc.syso

# GUIモードでビルド（コンソールウィンドウを非表示）
go build -ldflags "-H windowsgui" -o shutdown-alert.exe .
```

### 6.4. デバッグビルド

コンソール出力を確認したい場合は、`-ldflags`を省略する：

```cmd
go build -o shutdown-alert-debug.exe .
```

## 7. ライブラリとツール

- **`github.com/lxn/walk`**: UIおよびWindowsイベント処理に使用。
- **`github.com/lxn/win`**: Win32 API（SetWindowLongPtr, ShellExecute等）の呼び出しに使用。
- **`github.com/akavel/rsrc`**: マニフェストファイル(`.manifest`)とアイコンファイル(`.ico`)を実行ファイルに埋め込むために使用するツール。
