# アプリケーション設計書 (フェーズ1)

## 1. はじめに

本ドキュメントは、`docs/仕様.md`で定義された要件を満たすためのアプリケーションの内部設計を定めるものである。

## 2. 設計方針

- **軽量・高速**: Go言語の特性を活かし、常駐時のリソース消費を最小限に抑える。
- **CGO不使用**: ビルドプロセスを簡潔に保ち、クロスコンパイルの複雑さを避けるため、CGOに依存しない設計とする。
- **WindowsネイティブAPI直接利用**: 外部UIライブラリに頼らず、`golang.org/x/sys/windows`パッケージ経由でWin32 APIを直接呼び出し、OSとの親和性と軽量性を両立する。
- **拡張性**: フェーズ2以降の機能追加を考慮し、関心を分離したコンポーネントベースの構造とする。

## 3. ディレクトリ構成

プロジェクトのルートディレクトリは以下のような構成とする。

```
shutdown-alert/
├── go.mod
├── go.sum
├── main.go               // アプリケーションのエントリーポイント
└── internal/
    ├── icon/
    │   └── icon.ico      // タスクトレイ用のアイコンファイル
    ├── config/
    │   └── config.go     // 設定値（URLなど）を管理
    └── app/
        └── app.go        // アプリケーション本体のロジック
```

- **`main.go`**: 主な責務は、アプリケーションの初期化と実行。
- **`/internal/app`**: ウィンドウ生成、メッセージループ、イベント処理、タスクトレイ管理など、アプリケーションの中核ロジックを担う。
- **`/internal/config`**: リマインド対象のURLなど、設定情報を管理する。
- **`/internal/icon`**: Go 1.16+ の `//go:embed` 機能で実行ファイルに埋め込むアイコンを配置する。

## 4. コンポーネント設計

### 4.1. `main.go` (エントリーポイント)

- `internal/app`からアプリケーションのインスタンスを生成し、実行する。
- アイコンリソースを `//go:embed` ディレクティブで読み込む。
- Windowsアプリケーションとして動作させるため、ビルドタグ `//go:build windows` を指定し、リンカフラグ `-ldflags="-H=windowsgui"` を使用して実行時にコンソールウィンドウが表示されないようにする。

### 4.2. `app`コンポーネント (`internal/app/app.go`)

Win32 APIを直接呼び出して、UIイベントとシステムイベントを処理する。

- **メッセージ専用ウィンドウ (`Message-Only Window`)**:
    - システムメッセージ（シャットダウン通知など）を受け取るためだけの、非表示のウィンドウを`user32.CreateWindowEx`で生成する。
    - このウィンドウがメッセージ処理の土台となる。
    - ウィンドウプロシージャ（`WndProc`）を実装し、`WM_QUERYENDSESSION`（シャットダウン/ログオフ検知）とタスクトレイからのカスタムメッセージを処理する。
    - `user32.GetMessage`などを用いてメッセージループを実装する。

- **タスクトレイ (`Notify Icon`)**:
    - アプリケーション起動時に`shell32.Shell_NotifyIcon`を使用してタスクトレイにアイコンを表示する。
    - `user32.CreatePopupMenu`で右クリックメニューを生成し、「終了」項目を追加する。
    - ユーザーが「終了」を選択した場合、`user32.PostQuitMessage`を呼び出してアプリケーションのメッセージループを終了させる。

- **確認ダイアログ (`Message Box`)**:
    - `WM_QUERYENDSESSION`検知時に、`user32.MessageBox`を呼び出してモーダルダイアログを生成・表示する。この関数はOS標準のダイアログであり、軽量。
    - ダイアログにはメッセージと「はい」「いいえ」ボタン（`MB_YESNO`スタイル）を表示する。
    - **`はい`（`IDYES`）選択時の動作**:
        1. `internal/config`からURLを取得する。
        2. `shell32.ShellExecute`を使用して、指定されたURLをデフォルトのブラウザで開く。
    - **`いいえ`（`IDNO`）選択時の動作**:
        1. 何もせず、処理を継続する。

### 4.3. `config`コンポーネント (`internal/config/config.go`)

- フェーズ1では、ハードコードされた固定のURLを返す簡単な関数を定義する。

```go
// internal/config/config.go
package config

const TargetURL = "https://www.google.com" // 仕様書記載の仮URL

func GetTargetURL() string {
    return TargetURL
}
```

## 5. 処理フロー

1.  **起動**:
    - `main.go`が実行され、`app`コンポーネントが初期化される。
    - `app`内でメッセージ専用ウィンドウが生成され、メッセージループが開始される。
    - タスクトレイにアイコンが表示される。

2.  **シャットダウン検知**:
    - OSがシャットダウン処理を開始すると、メッセージ専用ウィンドウが`WM_QUERYENDSESSION`メッセージを受け取る。
    - `app`コンポーネントの`WndProc`がこれを検知し、`user32.MessageBox`による確認ダイアログの表示処理をトリガーする。

3.  **ユーザー応答**:
    - 表示されたダイアログでユーザーが「はい」または「いいえ」をクリックする。
    - `MessageBox`の戻り値（`IDYES`/`IDNO`）に応じて、`app`コンポーネントが処理（ブラウザ起動 or 何もしない）を実行する。

4.  **終了**:
    - ユーザーがタスクトレイの「終了」メニューを選択する。
    - `app`コンポーネントの`WndProc`が対応するメッセージを検知し、`PostQuitMessage`を呼び出す。
    - メッセージループが終了し、アプリケーションが正常に終了する。

## 6. ライブラリとツール

- **`golang.org/x/sys/windows`**: Win32 API呼び出しのために使用。CGOは不要。
- **`//go:embed`**: Go 1.16+ の標準機能。アイコンファイルなどのリソースを実行ファイルに埋め込むために使用する。
