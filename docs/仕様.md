# アプリケーション仕様書 (フェーズ1)

## 1. アプリケーション概要

Windowsのシャットダウン/ログオフを検知し、ユーザーにリマインドを促すための常駐型ネイティブアプリケーション。

**仮称**: Shutdown Alert

## 2. 目的

PCのシャットダウン/ログオフ時に、勤怠打刻のような忘れがちなタスクをユーザーに通知し、実行を補助することを目的とする。フェーズ1では、まずリマインダー機能の基盤を構築する。

## 3. フェーズ1の機能要件

### 3.1. 基本動作

- アプリケーションはバックグラウンドで常駐し、OSのイベントを監視する。
- ユーザーが手動でアプリケーションを終了できる機能をタスクトレイ（通知領域）に設ける。

### 3.2. シャットダウン検知

- Windowsのシャットダウンまたはログオフイベントを検知する。

### 3.3. 確認ウィンドウの表示

- シャットダウンイベントを検知した際、以下の要素を持つ小さな確認ウィンドウを画面中央に表示する。
    - **タイトル**: `Shutdown Alert`
    - **メッセージ**: `PCをシャットダウンしようとしています。\n（URL）を開きますか？`
    - **ボタン**:
        - `開く(&O)` - キーボードショートカット: Alt+O（URLが設定されている場合のみ表示）
        - `閉じる(&E)` - キーボードショートカット: Alt+E（常に表示）

### 3.4. ウィンドウ操作への応答

- **`開く(&O)` ボタンをクリックした場合**:
    - 設定された特定のURLを、OS標準のウェブブラウザで開く。
    - フェーズ1では、URLはソースコード内に固定値として埋め込む。（例: `https://www.google.com`）
    - ブラウザを開いた後、アプリケーションを終了する。

- **`閉じる(&E)` ボタンをクリックした場合**:
    - 何も処理を行わず、アプリケーションを終了する。

- **ウィンドウの閉じるボタンをクリックした場合**:
    - `閉じる(&E)` と同様の動作とする。

### 3.5. アラートモード

- `TargetURL`を空文字列 `""` に設定した場合、アラートモードとして動作する。
- アラートモードでは、確認ウィンドウに「閉じる」ボタンのみが表示される。
- URLを開く機能は無効化され、シャットダウン時の確認のみを行う。
- これにより、単純なシャットダウンアラートアプリケーションとして使用できる。

## 4. 非機能要件

### 4.1. 技術スタック

- **言語**: Go
- **UIライブラリ**: Windows APIを直接利用するか、軽量なGo向けGUIライブラリ（[fyne](https://fyne.io/) や [walk](https://github.com/lxn/walk) などを検討）
- **配布形式**: 単一の実行可能ファイル (`.exe`)

### 4.2. パフォーマンス

- 常駐時のCPU・メモリ消費量が極力少ないこと。
- アプリケーションの起動が高速であること。
- 実行ファイルのサイズが過度に大きくならないこと。（目標: 20MB以下）

### 3.5. スタートアップ登録機能

- タスクトレイメニューから「スタートアップに登録(&S)」を選択できる。
- 登録すると、Windows起動時に自動的にアプリケーションが起動する。
- チェックマークで登録状態を表示する。
- 実行ファイルを移動した場合、次回起動時に自動的にパスを更新する。

### 3.6. エラーログ機能

- エラーが発生した場合、`error_log.json`にJSON形式で記録する。
- ログファイルは実行ファイルと同じディレクトリに配置する。
- 最大100エントリまで保持し、古いものから自動削除する。
- 正常動作時はログファイルを生成しない（エラーのみ記録）。

### 3.7. 2重起動防止機能

- アプリケーションの2重起動を防止する。
- 既にアプリケーションが起動している場合、2つ目の起動を試みるとエラーメッセージを表示して終了する。
- Win32 Mutex APIを使用して、プロセス間で排他制御を行う。
- アプリケーション固有の名前付きミューテックス（`Global\ShutdownAlert-{GUID}`）を使用する。
- アプリケーション終了時に自動的にミューテックスが解放される。

### 3.8. 外部設定ファイル機能

- 実行ファイルと同じディレクトリに`config.yaml`を配置することで、設定を外部から変更できる。
- YAML形式を採用し、コメントや複数行テキストに対応する。
- 設定ファイルがない場合は警告を表示し、デフォルト値で起動する。

**設定可能な項目**:
- `target_url`: シャットダウン時に開くURL（空文字列でアラートモード）
- `dialog_width`: 確認ダイアログの幅（ピクセル）
- `dialog_height`: 確認ダイアログの高さ（ピクセル）
- `dialog_message`: 確認ダイアログのメッセージ（複数行対応）

**セキュリティ**:
- URLは`http://`または`https://`スキームのみ許可
- `file://`、`javascript:`、`data:`などの危険なスキームは拒否
- ダイアログサイズは0～10000ピクセルの範囲に制限

**バリデーション**:
- 不正な設定値が検出された場合、エラーメッセージを表示してデフォルト値で起動
- メッセージが空文字列の場合はエラー

## 5. フェーズ1でスコープ外とすること
## 5. フェーズ1でスコープ外とすること

- jinjerとの直接的な連携（API利用など）
- 自動アップデート機能
- 詳細なログ出力機能（エラーログのみ実装）
