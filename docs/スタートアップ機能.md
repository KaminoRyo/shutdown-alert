# スタートアップ機能

## 概要

Windows起動時にアプリケーションを自動起動する機能を追加しました。

## 機能詳細

### 1. スタートアップ登録方法

トレイアイコンを右クリックして、メニューから「スタートアップに登録(&S)」を選択します。

- **登録時**: レジストリに実行ファイルのパスが登録され、Windows起動時に自動で起動するようになります。
- **解除時**: レジストリから登録が削除され、自動起動しなくなります。

### 2. 実装方法

#### レジストリキー
```
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
```

#### レジストリ値名
```
ShutdownAlert
```

#### 値の内容
実行ファイルの絶対パス（例: `C:\Users\god\Documents\program\shutdown-alert\shutdown-alert.exe`）

### 3. 技術的な詳細

#### 新規追加されたコンポーネント

**`internal/startup/startup.go`**
- `IsRegistered()`: スタートアップ登録状態を確認
- `Register()`: スタートアップに登録
- `Unregister()`: スタートアップから解除
- `UpdateIfNeeded()`: 実行ファイル移動時の自動パス更新
- `getExecutablePath()`: 実行ファイルの絶対パスを取得

**`internal/logger/logger.go`**
- `LogError()`: エラーをJSON形式でログファイルに記録
- エラーログファイル: `error_log.json`（実行ファイルと同じディレクトリ）
- 最大100エントリまで保持（自動ローテーション）

#### 変更されたコンポーネント

**`internal/config/config.go`**
- `TrayMenuStartup`: スタートアップメニュー項目のラベルを追加
- `RegistryValueName`: レジストリ値名を定義
- `IconResourceID`: リソースに埋め込まれたアイコンのIDを定義
- `MessageBoxTitleError`, `MessageBoxTitleSuccess`: メッセージボックスのタイトルを定義
- `StartupRegisterSuccessMessage`: スタートアップ登録成功メッセージを定義
- `StartupRegisterErrorMessageFormat`: スタートアップ登録失敗メッセージフォーマットを定義
- `StartupUnregisterSuccessMessage`: スタートアップ解除成功メッセージを定義
- `StartupUnregisterErrorMessageFormat`: スタートアップ解除失敗メッセージフォーマットを定義
- `LogFileName`: ログファイル名を定義
- `MaxLogEntries`: 最大ログエントリ数を定義

**`internal/ui/tray.go`**
- `InitNotifyIcon()`: スタートアップ切り替えコールバックを追加
- トレイメニューにスタートアップ項目を追加

**`internal/app/app.go`**
- `toggleStartup()`: スタートアップ登録の切り替え処理を実装
- 成功/失敗時にメッセージボックスで通知

### 4. 使用ライブラリ

- `golang.org/x/sys/windows/registry`: Windowsレジストリ操作用

### 5. 設計原則の遵守

- レジストリ操作は副作用を持つ関数として明示的にコメント
- エラーハンドリングを適切に実装
- ユーザーへのフィードバック（メッセージボックス）を提供
- 純粋関数と副作用関数を明確に分離

## 使用方法

1. アプリケーションを起動
2. タスクトレイのアイコンを右クリック
3. 「スタートアップに登録(&S)」を選択
4. 成功メッセージが表示されたら完了

## トラブルシューティング

### スタートアップ登録しても自動起動しない問題

**症状**: レジストリには正しく登録されているのに、Windows起動時にアプリが起動しない

**原因**: アイコンファイルのパスが相対パスだったため、スタートアップから起動した際にカレントディレクトリが異なり、アイコンファイルが見つからずにクラッシュしていた。

**解決策**: 
1. **レジストリのパスを引用符で囲む**
   - `C:\path\to\app.exe` → `"C:\path\to\app.exe"`
   - Windowsのベストプラクティスに準拠

2. **アイコンをリソースに埋め込む**（最重要）
   - `rsrc`ツールでアイコンを実行ファイルに埋め込み
   - `walk.NewIconFromResourceId(2)`でリソースID 2から読み込み
   - 外部ファイルへの依存を完全に排除

**実装の詳細**:
```go
// internal/ui/tray.go
// リソースから直接アイコンを読み込む（rsrcで埋め込まれたアイコン、リソースID=2）
icon, err := walk.NewIconFromResourceId(2)
```

### 実行ファイル移動時の自動パス更新

**機能**: 実行ファイルを移動しても、次回起動時に自動的にスタートアップパスを更新

**実装**:
- `app.Run()`で起動時に`startup.UpdateIfNeeded()`を呼び出し
- レジストリのパスと現在のパスを比較
- 異なる場合は自動的に新しいパスで再登録
- エラー発生時は`error_log.json`に記録

## エラーログ

### ログファイル
- **ファイル名**: `error_log.json`
- **配置場所**: 実行ファイルと同じディレクトリ
- **形式**: JSON配列
- **最大エントリ数**: 100（古いものから自動削除）

### ログ記録のタイミング
- ✅ パス取得に失敗した場合
- ✅ パス更新に失敗した場合
- ❌ 正常動作時（ログファイルが存在しない = 正常）

## 注意事項

- ユーザー権限で実行可能（管理者権限不要）
- 実行ファイルを移動した場合、次回起動時に自動的にパスを更新
- レジストリエディタ（regedit）から手動で確認・削除も可能
- アイコンは実行ファイルに埋め込み済み（外部ファイル不要）
- `.exe`ファイル単体で配布可能
