# Shutdown Alert

> [!NOTE]
> このアプリケーションはWindowsが対象です。


## 概要

Windowsのシャットダウン/ログオフ時に確認ダイアログを表示し、指定したURLを開くことができるタスクトレイ常駐型アプリケーションです。

### 特徴

- 軽量・高速なGo言語製
- Windowsネイティブなルック&フィール
- 関数型プログラミング原則に基づいた保守性の高い設計
- 責務ごとに分離されたモジュール構造
- 2重起動防止機能（既に起動している場合は起動を拒否）


## プロジェクト構造

```
shutdown-alert/
├── main.go                    # エントリーポイント
├── shutdown-alert.manifest    # Windowsマニフェスト
├── rsrc.syso                  # リソースファイル（ビルド時生成）
└── internal/
    ├── app/
    │   ├── app.go            # アプリケーションライフサイクル管理
    │   └── wndproc.go        # Win32ウィンドウプロシージャ
    ├── ui/
    │   ├── dialog.go         # ダイアログUI構築
    │   └── tray.go           # トレイアイコン構築
    ├── win32/
    │   ├── api.go            # Win32 API呼び出し
    │   └── constants.go      # Win32定数定義
    ├── config/
    │   └── config.go         # 設定管理
    ├── startup/
    │   └── startup.go        # スタートアップ登録管理
    ├── logger/
    │   └── logger.go         # エラーログ記録
    ├── mutex/
    │   └── mutex.go          # 2重起動防止
    └── icon/
        └── icon.ico          # アプリケーションアイコン
```

### 設計原則

本プロジェクトは`.clinerules`で定義された関数型プログラミング原則に従っています:

- **純粋関数の最大化**: 副作用のない関数を優先
- **副作用の明示**: 副作用を持つ関数には明示的にコメントを記載
- **状態の最小化**: グローバル変数は必要最小限に抑え、Win32制約を明示
- **責務の分離**: 各パッケージが単一の責務を持つよう設計

詳細は`docs/設計.md`を参照してください。

## 開発環境のセットアップ

### Goのインストール

このプロジェクトはGo言語でWindowsネイティブアプリケーションを開発するため、ローカル環境へのGoのインストールが必要です。一般的なWebアプリケーション開発でGoをDockerコンテナ内で利用するケースもありますが、本プロジェクトではWindowsのGUIやシャットダウンイベントを直接操作するため、ホストOSにGoを直接インストールする方法を推奨します。

以下の手順でGoをインストールしてください。

1.  **Go公式サイトにアクセス**:
    [https://go.dev/dl/](https://go.dev/dl/)

2.  **Windows向けインストーラーのダウンロード**:
    ページの中から "Microsoft Windows" 向けの `.msi` ファイルをダウンロードします。

3.  **インストールの実行**:
    ダウンロードしたインストーラーを実行し、画面の指示に従って進めます。通常、デフォルト設定で問題ありません。

4.  **インストールの確認**:
    コマンドプロンプトまたはPowerShellを開き、以下のコマンドを実行してGoのバージョンが表示されればインストール完了です。

    ```shell
    go version
    ```

    例: `go version go1.xx.x windows/amd64`

### rsrcツールのインストール

マニフェストとアイコンを実行ファイルに埋め込むために、`rsrc`ツールが必要です。

```shell
go install github.com/akavel/rsrc@latest
```

## ビルド方法

### 1. リソースファイルの生成

マニフェストとアイコンを埋め込むための`.syso`ファイルを生成します。

```shell
rsrc -manifest shutdown-alert.manifest -ico internal/icon/icon.ico -o rsrc.syso
```

### 2. アプリケーションのビルド

GUIモードでビルドします（コンソールウィンドウを非表示）。

```shell
go build -ldflags "-H windowsgui" -o shutdown-alert.exe .
```

### デバッグビルド

コンソール出力を確認したい場合は、`-ldflags`を省略します。

```shell
go build -o shutdown-alert-debug.exe .
```

## 使い方

1. `shutdown-alert.exe`をダブルクリックして起動
2. タスクトレイ（通知領域）にアイコンが表示されます
3. シャットダウン/ログオフ時に確認ダイアログが表示されます
4. 終了するには、タスクトレイのアイコンを右クリックして「Exit」を選択

### スタートアップ登録

Windows起動時に自動でアプリケーションを起動したい場合:

1. タスクトレイのアイコンを右クリック
2. 「スタートアップに登録(&S)」を選択
3. チェックマークが付いたら登録完了

**特徴**:
- ✅ 実行ファイルを移動しても、次回起動時に自動的にパスを更新
- ✅ `.exe`ファイル単体で動作（アイコンは実行ファイルに埋め込み済み）
- ✅ エラー発生時は`error_log.json`に記録

詳細は`docs/スタートアップ機能.md`を参照してください。

### テスト機能

タスクトレイのアイコンを右クリックして「Test Dialog」を選択すると、シャットダウンせずに確認ダイアログをテストできます。

## 開発

### テストの実行

```shell
go test ./...
```

### コードの整形

```shell
go fmt ./...
```

## 設定

### 外部設定ファイル（必須）

実行ファイルと同じディレクトリに`config.yaml`を配置する必要があります：

```yaml
# シャットダウン時に開くURL
target_url: "https://www.google.com"

# ダイアログのサイズ
dialog_width: 640
dialog_height: 480

# ダイアログメッセージ
# URLを開く場合は、メッセージ内にURLを直接書いてください
dialog_message: |
  PCをシャットダウンしようとしています。
  https://www.google.com を開きますか？
```

**設定項目**:
- `target_url`: シャットダウン時に開くURL（省略可）
  - **空文字列 `""` に設定すると、単なるアラートアプリとして動作します**（「開く」ボタンが非表示になり、「閉じる」ボタンのみ表示）
  - 省略した場合のデフォルト値: `"https://www.google.com"`
  - **セキュリティ**: `http://` または `https://` スキームのみ許可されます
- `dialog_width`: 確認ダイアログの幅（ピクセル、省略可）
  - 省略した場合のデフォルト値: `640`
  - 範囲: 0 ～ 10000
- `dialog_height`: 確認ダイアログの高さ（ピクセル、省略可）
  - 省略した場合のデフォルト値: `480`
  - 範囲: 0 ～ 10000
- `dialog_message`: 確認ダイアログのメッセージ（省略可）
  - 複数行で記述可能（`|` を使用）
  - URLを開く場合は、メッセージ内にURLを直接記述してください
  - 省略した場合のデフォルト値: `"PCをシャットダウンしようとしています。\n%s を開きますか？"`

**特徴**:
- ⚠️ 設定ファイルがない場合は警告ウィンドウが表示されます（デフォルト値で起動）
- ✅ 必要な項目のみ指定可能（省略した項目はデフォルト値を使用）
- ✅ 再ビルド不要で設定変更可能
- ✅ YAMLフォーマット（コメント対応、複数行テキスト対応）
- ✅ サンプルファイル（`config.yaml.example`）を参考に作成可能

**初回起動時の設定**:
1. `config.yaml.example`を`config.yaml`にコピー
2. 必要に応じて設定値を編集
3. アプリケーションを起動

### デフォルト設定（テスト用）

設定ファイルがない場合、警告が表示されますが以下のデフォルト値で起動します：
- `target_url`: `"https://www.google.com"`
- `dialog_width`: `640`
- `dialog_height`: `480`
- `dialog_message`: `"PCをシャットダウンしようとしています。\n%s を開きますか？"`

**注意**: デフォルト値はテスト確認用です。本番利用時は必ず`config.yaml`を作成してください。

### その他の設定

以下の設定は`internal/config/config.go`ファイルで管理されており、変更にはビルドが必要です：

- `DialogTitle`: 確認ダイアログのタイトル
- `ShutdownBlockMessage`: シャットダウン時に表示されるメッセージ
- `DialogMessageFormat`: 確認ダイアログのメッセージフォーマット
- `OpenButtonLabel`, `ExitButtonLabel`: 確認ダイアログのボタンのラベル
- `TrayIconTooltip`: タスクトレイアイコンのツールチップ
- `TrayMenuTest`, `TrayMenuExit`: タスクトレイメニューの項目名

### 設定例

#### 基本設定（すべての項目を指定）

```yaml
target_url: "https://www.google.com"
dialog_width: 640
dialog_height: 480
dialog_message: |
  PCをシャットダウンしようとしています。
  https://www.google.com を開きますか？
```

#### アラートモード（URLを開かない）

`target_url`を**空文字列**（`""`）に設定することで、URLを開かずにシャットダウン時の確認のみを行うアラートアプリとして使用できます。

```yaml
target_url: ""
```

この場合、確認ダイアログには「閉じる」ボタンのみが表示され、シャットダウンを中断するかどうかの確認だけを行います。

#### 最小限の設定（URLのみ変更）

URLのみ変更したい場合は、以下のように最小限の設定で済みます：

```yaml
target_url: "https://example.com"
```

省略した項目（`dialog_width`、`dialog_height`、`dialog_message`）はデフォルト値が使用されます。

#### カスタムメッセージ

ダイアログメッセージをカスタマイズする場合：

```yaml
target_url: "https://example.com"
dialog_message: |
  シャットダウンします。
  本当によろしいですか？
  https://example.com を開きます。
```

## セキュリティ

### URL検証

設定ファイルで指定されたURLは、以下のセキュリティチェックが行われます：

- ✅ **許可されるスキーム**: `http://` または `https://` のみ
- ❌ **禁止されるスキーム**: `file://`, `javascript:`, `data:` など
- ✅ **ホスト名の検証**: 有効なホスト名が必須

**不正なURLの例**:
```yaml
target_url: "file:///C:/Windows/System32/cmd.exe"  # ❌ エラー
```

```yaml
target_url: "javascript:alert('XSS')"  # ❌ エラー
```

不正なURLが検出された場合、アプリケーション起動時にエラーメッセージが表示され、デフォルト値で起動します。

### メッセージ検証

`dialog_message`には以下の制約があります：

- ❌ **空文字列**: 空のメッセージは許可されない
- ✅ **複数行**: YAMLの `|` 記法で複数行記述可能
- ✅ **自由記述**: URLを含めて自由にメッセージを記述できます

**不正なメッセージの例**:
```yaml
dialog_message: ""  # ❌ エラー（空文字列）
```

### ダイアログサイズの制限

ダイアログの幅と高さは 0 ～ 10000 ピクセルの範囲に制限されています。範囲外の値が指定された場合、エラーメッセージが表示されます。

## 既知の問題

> [!NOTE]
> **シャットダウン時の画面暗転について**
> 
> シャットダウン/ログオフを実行すると、確認ダイアログが表示される前に画面が暗転し、「確認ダイアログに応答してください」というメッセージが表示されます。これはWindowsのセキュリティ制約によるもので、アプリケーション側でシャットダウンプロセスを完全にブロックすることはできません。
> 
> **対処方法**: シャットダウン画面で「キャンセル」を押すとデスクトップに戻り、確認ダイアログが表示されます。

> [!NOTE]
> **ダイアログがスタートメニューに隠れる問題**
> 
> シャットダウンをキャンセルした後、確認ダイアログがスタートメニューやタスクバーの裏に隠れてしまうことがあります。これはWindowsのウィンドウ管理の仕様によるものです。
> 
> **対処方法**: スタートメニューを閉じるか、タスクバーのアイコンをクリックするか、Alt+Tabでウィンドウを切り替えてダイアログを前面に表示してください。
