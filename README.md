# Shutdown Alert

> [!NOTE]
> このアプリケーションはWindowsが対象です。


## 概要

Windowsのシャットダウン/ログオフ時に確認ダイアログを表示し、指定したURLを開くことができるタスクトレイ常駐型アプリケーションです。

### 特徴

- 軽量・高速なGo言語製
- Windowsネイティブなルック&フィール
- 関数型プログラミング原則に基づいた保守性の高い設計
- 責務ごとに分離されたモジュール構造


## プロジェクト構造

```
shutdown-alert/
├── main.go                    # エントリーポイント
├── shutdown-alert.manifest    # Windowsマニフェスト
├── rsrc.syso                  # リソースファイル（ビルド時生成）
└── internal/
    ├── app/
    │   ├── app.go            # アプリケーションライフサイクル管理
    │   └── wndproc.go        # Win32ウィンドウプロシージャ
    ├── ui/
    │   ├── dialog.go         # ダイアログUI構築
    │   └── tray.go           # トレイアイコン構築
    ├── win32/
    │   ├── api.go            # Win32 API呼び出し
    │   └── constants.go      # Win32定数定義
    ├── config/
    │   └── config.go         # 設定管理
    ├── startup/
    │   └── startup.go        # スタートアップ登録管理
    ├── logger/
    │   └── logger.go         # エラーログ記録
    └── icon/
        └── icon.ico          # アプリケーションアイコン
```

### 設計原則

本プロジェクトは`.clinerules`で定義された関数型プログラミング原則に従っています:

- **純粋関数の最大化**: 副作用のない関数を優先
- **副作用の明示**: 副作用を持つ関数には明示的にコメントを記載
- **状態の最小化**: グローバル変数は必要最小限に抑え、Win32制約を明示
- **責務の分離**: 各パッケージが単一の責務を持つよう設計

詳細は`docs/設計.md`を参照してください。

## 開発環境のセットアップ

### Goのインストール

このプロジェクトはGo言語でWindowsネイティブアプリケーションを開発するため、ローカル環境へのGoのインストールが必要です。一般的なWebアプリケーション開発でGoをDockerコンテナ内で利用するケースもありますが、本プロジェクトではWindowsのGUIやシャットダウンイベントを直接操作するため、ホストOSにGoを直接インストールする方法を推奨します。

以下の手順でGoをインストールしてください。

1.  **Go公式サイトにアクセス**:
    [https://go.dev/dl/](https://go.dev/dl/)

2.  **Windows向けインストーラーのダウンロード**:
    ページの中から "Microsoft Windows" 向けの `.msi` ファイルをダウンロードします。

3.  **インストールの実行**:
    ダウンロードしたインストーラーを実行し、画面の指示に従って進めます。通常、デフォルト設定で問題ありません。

4.  **インストールの確認**:
    コマンドプロンプトまたはPowerShellを開き、以下のコマンドを実行してGoのバージョンが表示されればインストール完了です。

    ```shell
    go version
    ```

    例: `go version go1.xx.x windows/amd64`

### rsrcツールのインストール

マニフェストとアイコンを実行ファイルに埋め込むために、`rsrc`ツールが必要です。

```shell
go install github.com/akavel/rsrc@latest
```

## ビルド方法

### 1. リソースファイルの生成

マニフェストとアイコンを埋め込むための`.syso`ファイルを生成します。

```shell
rsrc -manifest shutdown-alert.manifest -ico internal/icon/icon.ico -o rsrc.syso
```

### 2. アプリケーションのビルド

GUIモードでビルドします（コンソールウィンドウを非表示）。

```shell
go build -ldflags "-H windowsgui" -o shutdown-alert.exe .
```

### デバッグビルド

コンソール出力を確認したい場合は、`-ldflags`を省略します。

```shell
go build -o shutdown-alert-debug.exe .
```

## 使い方

1. `shutdown-alert.exe`をダブルクリックして起動
2. タスクトレイ（通知領域）にアイコンが表示されます
3. シャットダウン/ログオフ時に確認ダイアログが表示されます
4. 終了するには、タスクトレイのアイコンを右クリックして「Exit」を選択

### スタートアップ登録

Windows起動時に自動でアプリケーションを起動したい場合:

1. タスクトレイのアイコンを右クリック
2. 「スタートアップに登録(&S)」を選択
3. チェックマークが付いたら登録完了

**特徴**:
- ✅ 実行ファイルを移動しても、次回起動時に自動的にパスを更新
- ✅ `.exe`ファイル単体で動作（アイコンは実行ファイルに埋め込み済み）
- ✅ エラー発生時は`error_log.json`に記録

詳細は`docs/スタートアップ機能.md`を参照してください。

### テスト機能

タスクトレイのアイコンを右クリックして「Test Dialog」を選択すると、シャットダウンせずに確認ダイアログをテストできます。

## 開発

### テストの実行

```shell
go test ./...
```

### コードの整形

```shell
go fmt ./...
```

## 設定

本アプリケーションの設定は、`internal/config/config.go`ファイルで管理されています。
このファイルを直接編集することで、以下の設定を変更できます。

- `TargetURL`: シャットダウン時に開くURL
  - **空文字列 `""` に設定すると、単なるアラートアプリとして動作します**（「開く」ボタンが非表示になり、「閉じる」ボタンのみ表示）
- `DialogWidth`, `DialogHeight`: 確認ダイアログの幅と高さ
- `DialogTitle`: 確認ダイアログのタイトル
- `ShutdownBlockMessage`: シャットダウン時に表示されるメッセージ
- `DialogMessageFormat`: 確認ダイアログのメッセージフォーマット
- `OpenButtonLabel`, `ExitButtonLabel`: 確認ダイアログのボタンのラベル
- `TrayIconTooltip`: タスクトレイアイコンのツールチップ
- `TrayMenuTest`, `TrayMenuExit`: タスクトレイメニューの項目名

設定変更後は、再度ビルドしてください。

### アラートモードとして使用する

`TargetURL`を空文字列に設定することで、URLを開かずにシャットダウン時の確認のみを行うアラートアプリとして使用できます。

```go
// internal/config/config.go
const (
    TargetURL = "" // 空文字列に設定
    // ...
)
```

この場合、確認ダイアログには「閉じる」ボタンのみが表示され、シャットダウンを中断するかどうかの確認だけを行います。

## 既知の問題

> [!NOTE]
> **シャットダウン時の画面暗転について**
> 
> シャットダウン/ログオフを実行すると、確認ダイアログが表示される前に画面が暗転し、「確認ダイアログに応答してください」というメッセージが表示されます。これはWindowsのセキュリティ制約によるもので、アプリケーション側でシャットダウンプロセスを完全にブロックすることはできません。
> 
> **対処方法**: シャットダウン画面で「キャンセル」を押すとデスクトップに戻り、確認ダイアログが表示されます。

> [!NOTE]
> **ダイアログがスタートメニューに隠れる問題**
> 
> シャットダウンをキャンセルした後、確認ダイアログがスタートメニューやタスクバーの裏に隠れてしまうことがあります。これはWindowsのウィンドウ管理の仕様によるものです。
> 
> **対処方法**: スタートメニューを閉じるか、タスクバーのアイコンをクリックするか、Alt+Tabでウィンドウを切り替えてダイアログを前面に表示してください。
